{% extends 'base.html' %} {% block content %}
<h2>Receipt</h2>
{% if tx %}
<div class="card">
  <div><strong>Transaction Code:</strong> {{ tx.code }}</div>
  <!-- <div><strong>Customer:</strong> {{ tx.customer_name or '‚Äî' }}</div> -->
  <div>
    <strong>Therapist:</strong> {{ tx.therapist.name if tx.therapist else '‚Äî' }}
  </div>
  <div><strong>Room:</strong> {{ tx.room_number or '‚Äî' }}</div>
  <ul>
    {% for it in tx.items %}
    <li>
      {{ it.service.name }} - ‚Ç±{{ '%.2f'|format(it.price) }} ({{
      it.duration_minutes }}m)
    </li>
    {% endfor %}
  </ul>
  <div><strong>Total:</strong> ‚Ç±{{ '%.2f'|format(tx.total_amount) }}</div>
  {% if tx.payment %}
  <div>
    <strong>Paid:</strong> ‚Ç±{{ '%.2f'|format(tx.payment.amount_paid) }} ({{
    tx.payment.method }})
  </div>
  <div>
    <strong>Change:</strong> ‚Ç±{{ '%.2f'|format(tx.payment.change_amount) }}
  </div>
  <div><strong>Date:</strong> {{ tx.payment.created_at }}</div>
  {% endif %}
</div>

<div style="margin-top: 20px;">
  <button id="printBtn" class="btn btn-primary" onclick="printToThermalPrinter({{ tx.id }})">
    üñ®Ô∏è Print Receipt (Thermal)
  </button>
  <span id="printStatus" style="margin-left: 10px; display: none;"></span>
</div>

{% else %}
<p>Transaction not found.</p>
{% endif %}

<script>
function printToThermalPrinter(transactionId) {
  const printBtn = document.getElementById('printBtn');
  const printStatus = document.getElementById('printStatus');
  
  printBtn.disabled = true;
  printStatus.style.display = 'inline';
  printStatus.textContent = 'Printing...';
  printStatus.style.color = 'blue';
  
  fetch('/cashier/print-receipt', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      transaction_id: transactionId,
      printer_host: 'localhost',
      printer_port: 9100
    })
  })
  .then(response => response.json())
  .then(data => {
    printBtn.disabled = false;
    if (data.success) {
      printStatus.textContent = '‚úì Receipt printed successfully!';
      printStatus.style.color = 'green';
      setTimeout(() => {
        printStatus.style.display = 'none';
      }, 3000);
    } else {
      printStatus.textContent = '‚úó Error: ' + (data.error || 'Unknown error');
      printStatus.style.color = 'red';
    }
  })
  .catch(error => {
    printBtn.disabled = false;
    printStatus.textContent = '‚úó Connection error: ' + error.message;
    printStatus.style.color = 'red';
  });
}
</script>
{% endblock %}
